<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <meta name="description" content="An income and expenses calculator">
    <meta name="author" content="Donovan Maas">

    <title>Income & Expenses Calculator</title>

    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.2.3/dist/css/bootstrap.min.css" rel="stylesheet" integrity="sha384-rbsA2VBKQhggwzxH7pPCaAqO46MgnOM80zW1RWuH61DGLwZJEdK2Kadq2F9CUG65" crossorigin="anonymous">
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.2.3/dist/js/bootstrap.bundle.min.js" integrity="sha384-kenU1KFdBIe4zVF0s0G1M5b4hcpxyD9F7jL+jjXkk+Q2h455rYXK/7HAuoJl+0I4" crossorigin="anonymous"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/Chart.js/4.2.1/chart.umd.min.js" integrity="sha512-GCiwmzA0bNGVsp1otzTJ4LWQT2jjGJENLGyLlerlzckNI30moi2EQT0AfRI7fLYYYDKR+7hnuh35r3y1uJzugw==" crossorigin="anonymous" referrerpolicy="no-referrer"></script>

    <script src="https://www.donovanmaas.dev/commonUtils.js" crossorigin="anonymous" async></script>

    <!-- Global site tag (gtag.js) - Google Analytics -->
    <script async src="https://www.googletagmanager.com/gtag/js?id=G-B1ELNH44BM"></script>
    <script>
        window.dataLayer = window.dataLayer || [];
        function gtag(){dataLayer.push(arguments);}
        gtag('js', new Date());

        gtag('config', 'G-B1ELNH44BM');
        // Disable Ad Tracking
        gtag('set', 'allow_google_signals', false);
        // Disable Ad Personalization on this site.
        gtag('set', 'allow_ad_personalization_signals', false);
    </script>

    <style>
        canvas {
            width: 100%;
            height: auto;
        }
    </style>
</head>

<body>
    <div class="container-fluid">
        <div class="row">
            <div class="col">
                <div class="container">
                    <div class="d-flex p-2">
                        <h1>Income & Expenses Calculator</h1>
                    </div>  
                </div>
            </div>
        </div>

        <div class="row">
            <div class="col">
                <div class="container">
                    <hr>
                    <form>
                        <div class="row">
                            <div class="col col-12 col-sm-12 col-md">
                                <div class="mb-2">
                                    <label id="principleInputLabel" for="principleInput" class="form-label">Principle</label>
                                    <div class="input-group">
                                        <span class="input-group-text">$</span>
                                        <input type="text" class="form-control" id="principleInput" aria-labelledby="principleInputLabel" value="1000" required>
                                    </div>
                                </div>
                                <div class="mb-3">
                                    <input type="range" class="form-range" id="principleRangeInput" aria-labelledby="principleInputLabel" value="1000" min="0" max="5000000">
                                </div>
                                <div class="mb-2">
                                    <label id="contributionInputLabel" for="contributionInput" class="form-label">Annual Contribution</label>
                                    <div class="input-group">
                                        <span class="input-group-text">$</span>
                                        <input type="text" class="form-control" id="contributionInput" aria-labelledby="contributionInputLabel" value="12000" required>
                                    </div>
                                </div>
                                <div class="mb-3">
                                    <input type="range" class="form-range" id="contributionRangeInput" aria-labelledby="contributionInputLabel" value="12000" min="0" max="50000">
                                </div>
                            </div>
                            <div class="col col-12 col-sm col-md">
                                <div class="mb-3">
                                    <label id="interestInputLabel" for="interestInput" class="form-label">Annual Interest Rate</label>
                                    <div class="input-group">
                                        <input type="text" class="form-control" id="interestInput" aria-labelledby="interestInputLabel" value="8" required>
                                        <span class="input-group-text">%</span>
                                    </div>
                                </div>
                                <div class="mb-3">
                                    <label id="interestDeviationInputLabel" for="interestDeviationInput" class="form-label">Interest Deviation</label>
                                    <div class="input-group">
                                        <input type="text" class="form-control" id="interestDeviationInput" aria-labelledby="interestDeviationInputLabel" value="2" required>
                                        <span class="input-group-text">%</span>
                                    </div>
                                </div>
                                <div class="mb-3">
                                    <label id="contributionIncreasePercentInputLabel" for="contributionIncreasePercentInput" class="form-label">Contribution Increase Per Year</label>
                                    <div class="input-group">
                                        <input type="text" class="form-control" id="contributionIncreasePercentInput" aria-labelledby="contributionIncreasePercentInputLabel" value="5" required>
                                        <span class="input-group-text">%</span>
                                    </div>
                                </div>
                                <div class="mb-3">
                                    <label id="distributionPercentInputLabel" for="distributionPercentInput" class="form-label">Annual Distribution Percent</label>
                                    <div class="input-group">
                                        <input type="text" class="form-control" id="distributionPercentInput" aria-labelledby="distributionPercentInputLabel" value="3" required>
                                        <span class="input-group-text">%</span>
                                    </div>
                                </div>
                            </div>
                            <div class="col col-12 col-sm col-md">
                                <div class="mb-2">
                                    <label id="yearsInputLabel" for="yearsInput" class="form-label">Years</label>
                                    <input type="text" class="form-control" id="yearsInput" aria-labelledby="yearsInputLabel" value="60" required>
                                </div>
                                <div class="mb-3">
                                    <input type="range" class="form-range" id="yearsRangeInput" aria-labelledby="yearsInputLabel" value="60" min="0" max="100">
                                </div>
                                <div class="mb-2">
                                    <label id="distributionYearInputLabel" for="distributionYearInput" class="form-label">Start Distribution Year</label>
                                    <input type="text" class="form-control" id="distributionYearInput" aria-labelledby="distributionYearInputLabel" value="40" required>
                                </div>
                                <div class="mb-3">
                                    <input type="range" class="form-range" id="distributionYearRangeInput" aria-labelledby="distributionYearInputLabel" value="40" min="0" max="100">
                                </div>
                            </div>
                        </div>
                    </form>
                    <hr>
                    <form>
                        <div class="row">
                            <div class="col">
                                <div class="mb-3">
                                    <label id="valuationOutputLabel" for="valuationOutput" class="form-label">Estimated Valuation Before Distributions</label>
                                    <div class="input-group">
                                        <span class="input-group-text">$</span>
                                        <input type="text" class="form-control" id="valuationOutput" aria-labelledby="valuationOutputLabel" value="0" readonly>
                                    </div>
                                </div>
                                <div class="mb-3">
                                    <label id="distributionOutputLabel" for="distributionOutput" class="form-label">Starting Annual Distribution</label>
                                    
                                    <div class="input-group">
                                        <span class="input-group-text">$</span>
                                        <input type="text" class="form-control" id="distributionOutput" aria-labelledby="distributionOutputLabel" value="0" readonly>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </form>
                    <hr>
                    <div class="d-flex p-2">
                        <canvas id="interestGraph"></canvas>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <script>

        (function() {
            "use strict";
            window.addEventListener("load", function() {
                const interestGraphCanvas = document.getElementById("interestGraph");

                const principleInput = document.getElementById("principleInput");
                const principleRangeInput = document.getElementById("principleRangeInput");
                
                const contributionInput = document.getElementById("contributionInput");
                const contributionRangeInput = document.getElementById("contributionRangeInput");

                const contributionIncreasePercentInput = document.getElementById("contributionIncreasePercentInput");
                const interestInput = document.getElementById("interestInput");
                const interestDeviationInput = document.getElementById("interestDeviationInput");
                const distributionPercentInput = document.getElementById("distributionPercentInput");

                const yearsInput = document.getElementById("yearsInput");
                const yearsRangeInput = document.getElementById("yearsRangeInput");

                const distributionYearInput = document.getElementById("distributionYearInput");
                const distributionYearRangeInput = document.getElementById("distributionYearRangeInput");

                const valuationOutput = document.getElementById("valuationOutput");
                const distributionOutput = document.getElementById("distributionOutput");

                const chart = new Chart(
                    interestGraphCanvas,
                    {
                        type: "line",
                        options: {
                            tension: 0.3,
                            interaction: {
                                intersect: false,
                                mode: "nearest",
                                axis: "x"
                            }
                        },
                    }
                );

                function updateChartWithDeviation() 
                {
                    const principle = principleInput.underlyingValue * 1;
                    let contribution = contributionInput.underlyingValue * 1;
                    const interest = 1 + (interestInput.value / 100.0);
                    const interestDeviation = interestDeviationInput.value / 100.0;
                    const interestAbove = interest + interestDeviation;
                    const interestBelow = interest - interestDeviation;
                    const contributionInterest = 1 + (contributionIncreasePercentInput.value / 100.0);
                    const distributionPercent = distributionPercentInput.value / 100.0;
                    const years = yearsInput.value|0;
                    const distributionYear = distributionYearInput.value|0;

                    let currentValueAbove = principle;
                    let currentValue = principle;
                    let currentValueBelow = principle;

                    for(let i = 0; i <= years; ++i)
                    {
                        if(i == distributionYear || (i == years && distributionYear >= years))
                        {
                            valuationOutput.value = formatMoney(currentValue);
                            distributionOutput.value = formatMoney(currentValue * distributionPercent);
                        }

                        if(i >= distributionYear)
                        {
                            currentValueAbove -= currentValueAbove * distributionPercent;
                            currentValue -= currentValue * distributionPercent;
                            currentValueBelow -= currentValueBelow * distributionPercent;
                        }

                        chart.data.labels.push(i);
                        chart.data.datasets[0].data.push(currentValueAbove);
                        chart.data.datasets[1].data.push(currentValue);
                        chart.data.datasets[2].data.push(currentValueBelow);

                        if(i < distributionYear)
                        {
                            currentValueAbove += contribution;
                            currentValue += contribution;
                            currentValueBelow  += contribution;
                            
                            contribution *= contributionInterest;
                        }

                        currentValueAbove *= interestAbove;
                        currentValue *= interest;
                        currentValueBelow *= interestBelow;
                    }
                }

                function updateChartWithoutDeviation() 
                {
                    const principle = principleInput.underlyingValue * 1;
                    let contribution = contributionInput.underlyingValue * 1;
                    const interest = 1 + (interestInput.value / 100.0);
                    const interestDeviation = interestDeviationInput.value / 100.0;
                    const contributionInterest = 1 + (contributionIncreasePercentInput.value / 100.0);
                    const distributionPercent = distributionPercentInput.value / 100.0;
                    const years = yearsInput.value|0;
                    const distributionYear = distributionYearInput.value|0;

                    let currentValue = principle;

                    for(let i = 0; i <= years; ++i)
                    {
                        if(i == distributionYear || (i == years && distributionYear >= years))
                        {
                            valuationOutput.value = formatMoney(currentValue);
                            distributionOutput.value = formatMoney(currentValue * distributionPercent);
                        }

                        if(i >= distributionYear)
                        {
                            currentValue -= currentValue * distributionPercent;
                        }

                        chart.data.labels.push(i);
                        chart.data.datasets[0].data.push(currentValue);

                        if(i < distributionYear)
                        {
                            currentValue += contribution;
                            contribution *= contributionInterest;
                        }
                        currentValue *= interest;
                    }
                }

                function updateChart()
                {
                    const interestDeviation = interestDeviationInput.value / 100.0;
                    const years = yearsInput.value|0;
                    const distributionYear = distributionYearInput.value|0;

                    const valuationColor = "rgb(187, 27, 20)";
                    const valuationDistributionColor = "rgb(68, 228, 235)";
                    const inflationColor = "rgba(180, 90, 13, 0.3)";

                    chart.data.labels = [ ];

                    let inflationIndex;

                    if(interestDeviationInput.value != 0)
                    {
                        inflationIndex = 3;

                        chart.data.datasets = [
                            {
                                label: "Positive Deviation Over Time",
                                data: [ ],
                                borderColor: "rgb(0, 45, 79)",
                                segment: {
                                    borderColor: ctx => ctx.p0.parsed.x > distributionYear - 2 ? "rgb(255, 210, 176)" : undefined
                                }
                            },
                            {
                                label: "Valulation Over Time",
                                data: [ ],
                                borderColor: valuationColor,
                                segment: {
                                    borderColor: ctx => ctx.p0.parsed.x > distributionYear - 2 ? valuationDistributionColor : undefined
                                }
                            },
                            {
                                label: "Negative Deviation Over Time",
                                data: [ ],
                                borderColor: "rgb(19, 134, 135)",
                                segment: {
                                    borderColor: ctx => ctx.p0.parsed.x > distributionYear - 2 ? "rgb(235, 121, 120)" : undefined
                                }
                            },
                            {
                                label: "Inflation of $1,000,000",
                                data: [ ],
                                borderColor: inflationColor,
                                borderDash: [6, 6]
                            }
                        ];

                        updateChartWithDeviation();
                    }
                    else
                    {
                        inflationIndex = 1;

                        chart.data.datasets = [
                            {
                                label: "Valulation Over Time",
                                data: [ ],
                                borderColor: valuationColor,
                                segment: {
                                    borderColor: ctx => ctx.p0.parsed.x > distributionYear - 2 ? valuationDistributionColor : undefined
                                }
                            },
                            {
                                label: "Inflation of $1,000,000",
                                data: [ ],
                                borderColor: inflationColor,
                                borderDash: [6, 6]
                            }
                        ];

                        updateChartWithoutDeviation();
                    }

                    let inflationTracker = 1000000;

                    for(let i = 0; i <= years; ++i)
                    {
                        chart.data.datasets[inflationIndex].data.push(inflationTracker);
                        inflationTracker *= 1.02;
                    }

                    chart.update("none");
                }

                registerMoneyFormatter(principleInput);
                registerMoneyFormatter(contributionInput);

                updateChart();
                
                registerRangePair(principleInput, principleRangeInput, updateChart);
                registerRangePair(contributionInput, contributionRangeInput, updateChart);
                registerRangePair(yearsInput, yearsRangeInput, updateChart);
                registerRangePair(distributionYearInput, distributionYearRangeInput, updateChart);

                interestInput.addEventListener("input", updateChart);
                interestDeviationInput.addEventListener("input", updateChart);
                contributionIncreasePercentInput.addEventListener("input", updateChart);
                distributionPercentInput.addEventListener("input", updateChart);
            });
        })();
    </script>
</body>
</html>
